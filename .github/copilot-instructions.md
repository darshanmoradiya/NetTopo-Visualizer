# NetTopo Visualizer - AI Agent Instructions

## Project Overview

**NetTopo Visualizer** is a real-time network topology visualization app built with React 19, TypeScript, D3.js, and Vite. It displays live network scan data from a JSON file, auto-refreshing every 5 seconds to show an interactive force-directed graph with hub-and-spoke layout.

**Key Architecture:**
- **Data Flow:** Python scanner → `/var/www/reactapp/data/raw_data_complete.json` → React app polls via HTTP GET every 5s
- **Deployment:** Vite builds static assets served by Nginx on Ubuntu
- **Graph Layout:** D3 force simulation with automatic hub detection (highest connection count or first Switch type)

## Critical Data Schema

The app expects JSON at `/data/raw_data_complete.json` with this structure:

```typescript
{
  export_timestamp: string,
  data: {
    devices: { records: DeviceRecord[] },
    connections: { records: ConnectionRecord[] },
    // ... see types.ts for complete schema
  }
}
```

**Key Relationships:**
- `connections[].device_id` → `devices[].id` (source device)
- `connections[].mac_address` → target device MAC (may create "ghost" L2-only nodes)
- Graph uses MAC addresses as primary node IDs for consistency

## Development Workflow

```bash
# Dev server (hot reload)
npm run dev  # → http://localhost:5173

# Production build
npm run build  # Creates dist/ folder

# Deploy to Ubuntu/Nginx
./deploy.sh  # Requires sudo, see deploy.sh for details
```

**Data URL Configuration (runtime via env vars):**
- `VITE_TOPOLOGY_URL` - single URL
- `VITE_TOPOLOGY_URLS` - comma-separated fallback URLs
- `VITE_POLL_INTERVAL_MS` - polling interval (default 5000ms)
- See [App.tsx:52-55](App.tsx#L52-L55) for default URL fallback logic

## Component Architecture

**Three main views ([App.tsx](App.tsx)):**

1. **TopologyGraph** ([components/TopologyGraph.tsx](components/TopologyGraph.tsx))
   - D3 force-directed layout with zoom/pan
   - Auto-detects hub node (highest link count or first Switch)
   - Creates "ghost" L2-only nodes for unscanned devices (from connections without matching device records)
   - Node types: Switch, ACTIVE_HOST, INACTIVE_HOST, MOBILE_DEVICE, L2_DEVICE
   - Search highlighting via `searchTerm` prop

2. **StatsPanel** ([components/StatsPanel.tsx](components/StatsPanel.tsx))
   - Recharts-based visualizations
   - Displays: device type breakdown, vendor distribution, confidence scores, port analysis

3. **DeviceList** ([components/DeviceList.tsx](components/DeviceList.tsx))
   - Filterable table of all devices
   - Click to select node and switch to graph view

**State Management:**
- Global search in [App.tsx:144-155](App.tsx#L144-L155) filters devices by name/IP/vendor
- Selected node managed via callback props (no Redux/Context needed)

## Project-Specific Conventions

### 1. **Atomic JSON Writes**
Use [write_topology_data.py](write_topology_data.py) pattern for external data generators:
```python
# Write to temp, then atomic rename
with tempfile.NamedTemporaryFile(mode='w', delete=False) as tmp:
    json.dump(data, tmp)
os.replace(tmp.name, target_path)  # Atomic on POSIX
```
This prevents React app from reading partial JSON during updates.

### 2. **Node ID Consistency**
Always use MAC address as primary node ID when available ([TopologyGraph.tsx:70](components/TopologyGraph.tsx#L70)):
```typescript
const nodeId = device.mac && device.mac !== 'Unknown MAC' 
  ? device.mac 
  : `dev-${device.id}`;
```

### 3. **Force Graph Layout**
Hub-and-spoke layout is automatic ([TopologyGraph.tsx:131-147](components/TopologyGraph.tsx#L131-L147)):
- Prefers nodes with `type === 'Switch'`
- Falls back to highest connection count
- Hub positioned at center, spokes radially distributed

### 4. **No-Cache Fetch Headers**
Always include cache-busting headers for live data ([App.tsx:67-69](App.tsx#L67-L69)):
```typescript
fetch(url, {
  cache: 'no-store',
  headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
})
```

### 5. **Error Handling Pattern**
Multi-URL fallback with graceful degradation ([App.tsx:52-104](App.tsx#L52-L104)):
- Try each URL in `DATA_URLS` array
- Check Content-Type to avoid parsing HTML as JSON
- Show loading spinner → error UI with retry button
- Display last update timestamp

## Deployment Specifics

**Target Environment:** Ubuntu 20.04+ with Nginx

**Directory Structure:**
```
/var/www/reactapp/
├── index.html
├── assets/          # Hashed JS/CSS bundles
└── data/
    └── raw_data_complete.json  # Generated by scanner
```

**Nginx Config Pattern (see [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)):**
- SPA fallback: `try_files $uri /index.html`
- CORS headers for JSON endpoint
- Gzip compression enabled
- Cache-Control: no-cache for `/data/*`

**Permission Setup:**
```bash
sudo chown -R your-user:www-data /var/www/reactapp/data
sudo chmod 775 /var/www/reactapp/data
```

## Key Files Reference

- [types.ts](types.ts) - Complete TypeScript interfaces for JSON schema
- [constants.ts](constants.ts) - Empty default data structure (not used in production)
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - Migration from static to dynamic data
- [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) - Full Nginx setup instructions
- [sample_data.json](sample_data.json) - Example JSON format with all fields

## Common Tasks

**Add new device type:**
1. Update device type check in [TopologyGraph.tsx](components/TopologyGraph.tsx) color/icon mapping
2. Add to legend rendering logic
3. Ensure `device_type_breakdown` in JSON reflects new type

**Modify polling interval:**
- Dev: Edit `POLL_MS` calculation in [App.tsx:55](App.tsx#L55)
- Prod: Set `VITE_POLL_INTERVAL_MS` env var before build

**Change graph physics:**
- Edit D3 force parameters in [TopologyGraph.tsx:161-166](components/TopologyGraph.tsx#L161-L166)
- Adjust `forceStrength`, `linkDistance`, `chargeStrength` for tighter/looser clustering

**Debug data loading:**
- Check browser Network tab for `/data/raw_data_complete.json` requests
- Verify JSON structure matches [types.ts](types.ts) interfaces
- Confirm no CORS issues (Nginx must serve JSON with CORS headers)
